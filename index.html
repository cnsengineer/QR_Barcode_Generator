<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNS : Bulk QR Tools (Testing)</title>
    
    <meta name="theme-color" content="#0046be">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="Logo.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script> window.DOMQRCode = window.QRCode; </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <script> window.HeadlessQRCode = window.QRCode; window.QRCode = window.DOMQRCode; </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS Design System (Original) --- */
        :root {
            --primary: #0f172a; --accent: #0046be; --accent-hover: #003399;
            --bg: #f3f6fc; --sidebar-bg: #ffffff; --text-main: #1e293b; --text-sec: #64748b;
            --border: #e2e8f0; --card-bg: #ffffff; --input-bg: #ffffff;
            --drop-bg: #f8fafc; --drop-border: #cbd5e1;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --sidebar-width: 280px;
        }
        [data-theme="dark"] {
            --primary: #f8fafc; --accent: #3b82f6; --accent-hover: #60a5fa;
            --bg: #0f172a; --sidebar-bg: #1e293b; --text-main: #f1f5f9; --text-sec: #94a3b8;
            --border: #334155; --card-bg: #1e293b; --input-bg: #334155;
            --drop-bg: #0f172a; --drop-border: #475569;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }
        
        /* Top Controls */
        .top-controls { position: fixed; top: 20px; right: 20px; z-index: 1100; display: flex; gap: 10px; }
        .control-btn { background: var(--card-bg); border: 2px solid var(--border); padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; color: var(--text-main); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .control-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }

        /* Sidebar */
        aside { 
            width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 1.5rem 1rem; 
            box-shadow: 2px 0 15px rgba(0,0,0,0.03); z-index: 900; transition: transform 0.3s ease; 
            height: 100vh;
        }
        .brand { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .brand-logo { max-width: 160px; height: auto; margin-bottom: 15px; display: block; object-fit: contain; transition: transform 0.3s; }
        .brand-logo:hover { transform: scale(1.05); }
        .program-name { font-size: 1.2rem; font-weight: 800; color: var(--accent); margin: 0; }
        .company-name { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; font-weight: 500; }

        nav { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; padding-bottom: 40px; }
        nav::-webkit-scrollbar { width: 4px; }
        nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .nav-group-title { font-size: 0.75rem; color: var(--text-sec); font-weight: 700; margin: 15px 0 5px 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        nav button { width: 100%; text-align: left; padding: 12px 15px; margin-bottom: 4px; border: none; background: none; border-radius: 8px; color: var(--text-sec); cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s, color 0.2s; }
        nav button:hover { background: var(--bg); color: var(--accent); }
        nav button.active { background: rgba(0, 70, 190, 0.08); color: var(--accent); font-weight: 700; border-left: 4px solid var(--accent); }
        [data-theme="dark"] nav button.active { background: rgba(59, 130, 246, 0.15); }
        nav button i { width: 24px; text-align: center; font-size: 1.1rem; }
        
        .dev-info { margin-top: auto; font-size: 0.7rem; color: var(--text-sec); text-align: center; border-top: 1px solid var(--border); padding-top: 1rem; line-height: 1.6; flex-shrink: 0; }

        /* Main Content */
        main { flex: 1; padding: 2rem; overflow-y: auto; position: relative; }
        .tool-panel { display: none; max-width: 900px; margin: 0 auto; animation: fadeIn 0.4s ease; padding-bottom: 60px; }
        .tool-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 1.5rem; }
        .panel-header h2 { color: var(--accent); margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.5rem; }
        .tool-desc { color: var(--text-sec); margin: 5px 0 0 0; font-size: 0.95rem; }

        .btn-reset { background: transparent; color: var(--text-sec); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-reset:hover { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* --- CARD & PREVIEW --- */
        .card { 
            background: var(--card-bg); border-radius: 12px; padding: 2rem; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); 
            transition: background 0.3s;
            display: flex; flex-direction: column;
            min-height: 720px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Sarabun', sans-serif; outline: none; transition: border 0.2s; font-size: 0.95rem; background: var(--input-bg); color: var(--text-main); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 70, 190, 0.1); }
        .form-group input:disabled { background-color: var(--drop-bg); color: var(--text-sec); cursor: not-allowed; }

        /* --- BULK TOOL CSS --- */
        .instruction-box { background: rgba(0, 70, 190, 0.05); border-radius: 10px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(0, 70, 190, 0.1); }
        .instruction-title { font-weight: 700; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
        .step-list { margin: 0; padding-left: 20px; color: var(--text-sec); font-size: 0.95rem; line-height: 1.6; }
        .step-list li { margin-bottom: 5px; }

        .upload-zone { border: 2px dashed var(--accent); border-radius: 10px; padding: 3rem 2rem; text-align: center; background-color: var(--drop-bg); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; margin-bottom: 1rem; }
        .upload-zone:hover, .upload-zone.dragover { background-color: rgba(0, 70, 190, 0.08); transform: scale(1.01); }
        .upload-icon { font-size: 3rem; color: var(--accent); }
        .upload-text { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .upload-sub { font-size: 0.9rem; color: var(--text-sec); }
        .preview-container { margin-top: 20px; overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; display: none; }
        .bulk-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .bulk-table th { background: var(--drop-bg); color: var(--text-main); font-weight: 700; text-align: left; padding: 12px; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .bulk-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-sec); vertical-align: middle; }
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar-bg { width: 100%; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.2s; }
        .progress-text { text-align: center; font-size: 0.9rem; margin-top: 5px; color: var(--text-main); }

        /* --- ACTION FOOTER --- */
        .action-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .btn-action { width: 100%; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: #fff; padding: 15px; border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; font-family: 'Sarabun', sans-serif; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 70, 190, 0.3); }
        .btn-action:disabled { background: var(--text-sec); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); font-weight: 600; padding: 10px; }
        .btn-outline:hover { background: var(--drop-bg); border-color: var(--accent); color: var(--accent); box-shadow: none; }

        .privacy-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 1rem; width: fit-content; border: 1px solid rgba(16, 185, 129, 0.2); }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: var(--card-bg); color: var(--text-main); padding: 14px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 12px; animation: slideUp 0.3s; border-left: 5px solid var(--accent); min-width: 280px; font-weight: 600; font-size: 0.95rem; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Responsive */
        @media (max-width: 768px) { 
            .menu-toggle { display: block; } 
            aside { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 10px 0 20px rgba(0,0,0,0.1); } 
            aside.open { transform: translateX(0); } 
            main { padding: 5rem 1rem 2rem 1rem; } 
            .card { min-height: auto; padding: 1.5rem; } 
            .grid-2 { grid-template-columns: 1fr; gap: 1rem; } 
            .top-controls { top: 15px; right: 15px; } 
            .control-btn { padding: 6px 12px; } 
            .menu-overlay.active { display: block; } 
        }
        
        .menu-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--accent); color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 800; backdrop-filter: blur(2px); }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--drop-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--text-sec); }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="menu-overlay" onclick="toggleSidebar()"></div>
    
    <div class="top-controls">
        <button class="control-btn" onclick="toggleTheme()" title="Toggle Dark Mode"><i class="fas fa-moon" id="theme-icon"></i></button>
        <button class="control-btn" onclick="toggleLanguage()"><i class="fas fa-globe"></i> <span id="lang-label">TH</span></button>
    </div>

    <aside id="sidebar">
        <div class="brand">
            <img src="Logo.png" alt="Logo" class="brand-logo" onerror="this.style.display='none';">
            <h1 class="program-name">CNS : Generator Tools</h1>
            <p class="company-name">CNS Computer Co., Ltd.</p>
        </div>
        <nav>
            <div class="nav-group-title" data-i18n="grp_bulk">Batch Processing</div>
            <button class="active" onclick="switchTab('bulk', this)"><i class="fas fa-file-excel"></i> <span data-i18n="menu_bulk">Bulk QR Excel</span></button>
        </nav>
        <div class="dev-info">© 2026 CNS Computer Co., Ltd.<br><span style="color: var(--accent); font-weight: 600;">Developed by MaRcH WoRaWiT</span></div>
    </aside>

    <main>
        <div id="bulk" class="tool-panel active">
            <div class="panel-header">
                <div><h2><i class="fas fa-file-excel"></i> <span data-i18n="title_bulk">Bulk QR Generator</span></h2><p class="tool-desc" data-i18n="desc_bulk">สร้าง QR Code จำนวนมากจากไฟล์แนบ พร้อมส่งออกเป็น Excel</p></div>
            </div>
            <div class="card">
                <div class="instruction-box" id="bulk-instructions">
                    <div class="instruction-title"><i class="fas fa-book"></i> <span data-i18n="lbl_instruction">คู่มือการใช้งาน (Instructions)</span></div>
                    <ul class="step-list">
                        <li data-i18n="step_1">1. เตรียมไฟล์ Excel (.xlsx) ที่มีข้อมูลใน Column A</li>
                        <li data-i18n="step_2">2. อัปโหลดไฟล์ที่เตรียมไว้ลงในช่องด้านล่าง</li>
                        <li data-i18n="step_3">3. กดปุ่ม "สร้างและดาวน์โหลด" ระบบจะสร้าง QR Code ใส่ไฟล์ Excel ให้ทันที</li>
                    </ul>
                </div>

                <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".xlsx, .xls, .csv, .txt" style="display:none;" onchange="handleFileSelect(this.files[0])">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div><div class="upload-text" data-i18n="lbl_drop">คลิก หรือ ลากไฟล์มาวางที่นี่</div><div class="upload-sub" data-i18n="lbl_support">รองรับ Excel (.xlsx), CSV, หรือ Text File (.txt)</div></div>
                </div>

                <div id="settings-area" style="display:none;">
                    <button class="btn-outline" onclick="resetBulkUI()" style="margin-bottom: 20px; width: 100%; justify-content:center; border-style:dashed;">
                        <i class="fas fa-arrow-left"></i> <span data-i18n="btn_reupload">อัปโหลดไฟล์ใหม่ (Upload New File)</span>
                    </button>

                    <div class="grid-2">
                        <div class="form-group">
                            <label data-i18n="lbl_col">เลือกคอลัมน์ข้อมูล (Column)</label>
                            <select id="col-select" onchange="updatePreview()"><option value="0">Column A / Text Line</option></select>
                        </div>
                        <div class="form-group">
                            <label>ระดับความทนทาน (ECC Level)</label>
                            <select id="bulk-ecc">
                                <option value="L">L (7%)</option>
                                <option value="M" selected>M (15%)</option>
                                <option value="Q">Q (25%)</option>
                                <option value="H">H (30%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ชื่อไฟล์ผลลัพธ์ (ไม่ต้องใส่ .xlsx)</label>
                        <input type="text" id="bulk-filename" placeholder="CNS_Result">
                    </div>

                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <span class="privacy-badge" style="background:var(--drop-bg); color:var(--text-sec); border:1px solid var(--border); border-radius:4px; padding:5px 10px; font-size:0.8rem;"><i class="fas fa-file-alt"></i> <span id="file-name-display">filename.xlsx</span></span>
                        <span class="privacy-badge" style="background:var(--drop-bg); color:var(--text-sec); border:1px solid var(--border); border-radius:4px; padding:5px 10px; font-size:0.8rem;"><i class="fas fa-list-ol"></i> <span id="row-count-display">0 rows</span></span>
                    </div>

                    <h4 style="margin-top:20px; color:var(--text-main);" data-i18n="lbl_preview">ตัวอย่างข้อมูล (5 รายการแรก)</h4>
                    <div class="preview-container" style="display:block;">
                        <table id="preview-table" class="bulk-table"><thead><tr><th>No.</th><th>Data</th><th>QR Preview</th></tr></thead><tbody></tbody></table>
                    </div>

                    <div class="progress-container" id="progress-container"><div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill"></div></div><div class="progress-text" id="progress-text">Processing 0/0...</div></div>
                    <div class="action-footer"><button class="btn-action" id="btn-process" onclick="processAndDownload()"><i class="fas fa-cogs"></i> <span data-i18n="btn_process">สร้างและดาวน์โหลด Excel</span></button></div>
                </div>
            </div>
        </div>

    </main>

    <div id="toast-container"></div>

    <script>
        const i18n = {
            th: {
                grp_bulk: "Batch Processing",
                menu_bulk: "QR จากไฟล์ (Bulk Excel)",
                title_bulk: "Bulk QR Generator", desc_bulk: "สร้าง QR Code จำนวนมากจากไฟล์แนบ พร้อมส่งออกเป็น Excel",
                lbl_instruction: "คู่มือการใช้งาน (Instructions)", step_1: "1. เตรียมไฟล์ Excel (.xlsx) ที่มีข้อมูลใน Column A", step_2: "2. อัปโหลดไฟล์ที่เตรียมไว้ลงในช่องด้านล่าง", step_3: "3. กดปุ่ม 'สร้างและดาวน์โหลด' ระบบจะสร้าง QR Code ใส่ไฟล์ Excel ให้ทันที", 
                lbl_drop: "คลิก หรือ ลากไฟล์มาวางที่นี่", lbl_support: "รองรับ Excel (.xlsx), CSV, หรือ Text File (.txt)", lbl_col: "เลือกคอลัมน์ข้อมูลที่จะทำ QR", lbl_preview: "ตัวอย่างข้อมูล (5 แถวแรก)", btn_process: "สร้างและดาวน์โหลด Excel", btn_reupload: "อัปโหลดไฟล์ใหม่ (Upload New File)", msg_load_ok: "อ่านไฟล์เรียบร้อย", msg_process_start: "กำลังประมวลผล กรุณารอสักครู่...", msg_complete: "เสร็จสิ้น! กำลังดาวน์โหลด", msg_error: "เกิดข้อผิดพลาดในการอ่านไฟล์", msg_no_data: "ไม่พบข้อมูลในไฟล์",
                btn_copy: "คัดลอกรูป", btn_download: "ดาวน์โหลด", btn_reset: "ล้างค่า",
                msg_copy_ok: "คัดลอกรูปเรียบร้อย", msg_offline: "ไม่สามารถโหลด Libraries ได้ กรุณาเชื่อมต่ออินเทอร์เน็ต"
            },
            en: {
                grp_bulk: "Batch Processing",
                menu_bulk: "Bulk QR from File",
                title_bulk: "Bulk QR Generator", desc_bulk: "Convert codes/text from Excel/Text file to QR Codes instantly",
                lbl_instruction: "Instructions", step_1: "1. Prepare Excel file with data in Column A", step_2: "2. Upload your file below", step_3: "3. Click 'Generate & Download' to get Excel with QR Codes",
                lbl_drop: "Click or Drop file here", lbl_support: "Supports Excel (.xlsx), CSV, or Text File (.txt)", lbl_col: "Select Data Column", lbl_preview: "Data Preview (First 5 rows)", btn_process: "Generate & Download Excel", btn_reupload: "Upload New File", msg_load_ok: "File loaded successfully", msg_process_start: "Processing... Please wait", msg_complete: "Done! Downloading...", msg_error: "Error reading file", msg_no_data: "No data found",
                btn_copy: "Copy Image", btn_download: "Download", btn_reset: "Reset",
                msg_copy_ok: "Copied successfully", msg_offline: "Cannot load libraries. Please check internet."
            }
        };

        let curLang = localStorage.getItem('cns_gen_lang') || 'th';
        let globalData = [];
        let excelHeader = [];
        let isExcel = false;

        // --- UI FUNCTIONS ---
        function applyLanguage(){
            document.getElementById('lang-label').innerText = curLang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(i18n[curLang][k]) el.innerText = i18n[curLang][k];
            });
        }
        function toggleLanguage() { curLang = curLang === 'th' ? 'en' : 'th'; localStorage.setItem('cns_gen_lang', curLang); applyLanguage(); }
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('cns_gen_theme', newTheme);
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.menu-overlay').classList.toggle('active'); }
        
        function switchTab(id, btn) {
            document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
            const panel = document.getElementById(id);
            if(panel) panel.classList.add('active');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function toast(m, type='success'){ const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`toast ${type}`; e.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i><span>${m}</span>`; c.appendChild(e); setTimeout(()=>e.remove(),3000); }

        // --- BULK FUNCTIONS ---
        function resetBulkUI() {
            document.getElementById('settings-area').style.display = 'none';
            document.getElementById('drop-zone').style.display = 'flex';
            document.getElementById('bulk-instructions').style.display = 'block'; 
            document.getElementById('file-input').value = ''; 
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('btn-process').disabled = false;
            globalData = [];
            excelHeader = [];
            document.querySelector('#preview-table tbody').innerHTML = ''; 
            document.getElementById('row-count-display').innerText = '0 rows';
            document.getElementById('file-name-display').innerText = 'filename.xlsx';
        }

        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
        });

        function handleFileSelect(file) {
            if (!file) return;
            const reader = new FileReader();
            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            document.getElementById('file-name-display').innerText = fileName;
            
            reader.onload = function(e) {
                const data = e.target.result;
                globalData = []; excelHeader = [];

                if (ext === 'txt') {
                    isExcel = false;
                    const lines = data.split(/\r\n|\n/).filter(line => line.trim() !== '');
                    globalData = lines.map(l => [l.trim()]);
                    setupColumns(['Text Data']);
                } else if (['xlsx', 'xls', 'csv'].includes(ext)) {
                    isExcel = true;
                    try {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                        if (json.length > 0) {
                            excelHeader = json[0];
                            globalData = json.slice(1);
                            setupColumns(excelHeader.map((h, i) => h || `Col ${i+1}`));
                        } else { toast(i18n[curLang].msg_no_data, 'error'); return; }
                    } catch (err) { toast(i18n[curLang].msg_error, 'error'); return; }
                } else { toast("Unsupported file type", 'error'); return; }

                if (globalData.length > 0) {
                    document.getElementById('row-count-display').innerText = `${globalData.length} rows`;
                    document.getElementById('drop-zone').style.display = 'none';
                    document.getElementById('bulk-instructions').style.display = 'none'; 
                    document.getElementById('settings-area').style.display = 'block';
                    updatePreview();
                    toast(i18n[curLang].msg_load_ok);
                }
            };
            if (ext === 'txt') reader.readAsText(file); else reader.readAsBinaryString(file);
        }

        function setupColumns(headers) {
            const select = document.getElementById('col-select'); select.innerHTML = '';
            headers.forEach((h, index) => { const opt = document.createElement('option'); opt.value = index; opt.innerText = h; select.appendChild(opt); });
        }

        async function updatePreview() {
            const colIndex = parseInt(document.getElementById('col-select').value);
            const tbody = document.querySelector('#preview-table tbody'); tbody.innerHTML = '';
            const previewCount = Math.min(globalData.length, 5);
            for (let i = 0; i < previewCount; i++) {
                const row = globalData[i];
                const textVal = row[colIndex] || "";
                const tr = document.createElement('tr');
                let qrImgHtml = '<span style="color:#ccc;">...</span>';
                if(textVal) {
                    try {
                        const url = await HeadlessQRCode.toDataURL(String(textVal), { width: 50, margin: 1 });
                        qrImgHtml = `<img src="${url}" style="width:50px; border-radius:4px;">`;
                    } catch(e) {}
                }
                tr.innerHTML = `<td>${i + 1}</td><td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${textVal}</td><td>${qrImgHtml}</td>`;
                tbody.appendChild(tr);
            }
        }

        async function processAndDownload() {
            const btn = document.getElementById('btn-process');
            const progressContainer = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            const txt = document.getElementById('progress-text');
            const colIndex = parseInt(document.getElementById('col-select').value);
            
            const qrSize = 150; 
            const rowHeightPx = 230;
            const colWidthPx = 210; 
            const ecc = document.getElementById('bulk-ecc').value;
            let filename = document.getElementById('bulk-filename').value || "CNS_QR_Result";
            filename = filename.replace(/[^a-z0-9_.-]/gi, '_'); 
            const rowOffset = 40 / 230; 
            const colOffset = 30 / 210;

            btn.disabled = true; progressContainer.style.display = 'block'; fill.style.width = '0%';

            setTimeout(async () => {
                try {
                    const workbook = new ExcelJS.Workbook();
                    const sheet = workbook.addWorksheet('QR Codes');
                    let headers = isExcel ? [...excelHeader] : ['Data'];
                    headers.push('QR Code Image');
                    sheet.addRow(headers);
                    sheet.getRow(1).font = { bold: true, size: 12 };
                    sheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

                    const total = globalData.length;
                    const rowHeightPt = rowHeightPx * 0.75; 
                    const colWidthChars = colWidthPx / 7;

                    for (let i = 0; i < total; i++) {
                        const originalRow = globalData[i];
                        const textData = String(originalRow[colIndex] || "");
                        const newRow = sheet.addRow([...originalRow]); 
                        const rowNum = i + 2;
                        sheet.getRow(rowNum).height = rowHeightPt;

                        if (textData) {
                            try {
                                const qrDataUrl = await HeadlessQRCode.toDataURL(textData, { width: qrSize, margin: 1, errorCorrectionLevel: ecc });
                                const imageId = workbook.addImage({ base64: qrDataUrl, extension: 'png' });
                                const colCount = headers.length; 
                                sheet.addImage(imageId, { tl: { col: colCount - 1 + colOffset, row: rowNum - 1 + rowOffset }, ext: { width: qrSize, height: qrSize }, editAs: 'oneCell' });
                                sheet.getCell(rowNum, colCount).alignment = { vertical: 'middle', horizontal: 'center' };
                            } catch (e) { console.error("QR Gen Error", e); }
                        }

                        if (i % 10 === 0 || i === total - 1) {
                            const percent = Math.round(((i + 1) / total) * 100);
                            fill.style.width = `${percent}%`;
                            txt.innerText = `Processing ${i + 1}/${total}...`;
                            await new Promise(r => setTimeout(r, 0));
                        }
                    }
                    sheet.columns.forEach((column, index) => { if(index < headers.length - 1) column.width = 25; });
                    sheet.getColumn(headers.length).width = colWidthChars;

                    txt.innerText = "Finalizing Excel file...";
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    saveAs(blob, `${filename}.xlsx`);
                    toast(i18n[curLang].msg_complete);
                    btn.disabled = false;
                } catch (err) { toast("Error: " + err.message, "error"); btn.disabled = false; }
            }, 100);
        }

        window.onload = function() {
            if(typeof window.HeadlessQRCode === 'undefined') alert(i18n['th'].msg_offline);
            if(localStorage.getItem('cns_gen_theme') === 'dark') { document.body.setAttribute('data-theme', 'dark'); document.getElementById('theme-icon').className = 'fas fa-sun'; }
            if(localStorage.getItem('cns_gen_lang')) curLang = localStorage.getItem('cns_gen_lang');
            applyLanguage();
        }
    </script>
</body>
</html>
